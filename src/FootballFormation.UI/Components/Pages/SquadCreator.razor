@page "/squad-creator"
@using FootballFormation.UI.Models
@using FootballFormation.UI.Services
@using FootballFormation.UI.Enums
@using FootballFormation.UI.Components
@inject ISquadCreationService SquadCreationService
@inject IPlayerAvailabilityService PlayerAvailabilityService
@inject HttpClient HttpClient

<PageTitle>Squad Creator</PageTitle>

<div class="squad-creator-container">
    <div class="page-header">
        <div class="container-fluid">
            <h1>Squad Creator</h1>
            <p>Create optimal squads based on player positions, availability, and strategic preferences</p>
        </div>
    </div>

    <div class="container-fluid">
        @if (!_dataLoaded)
        {
            <div class="load-data-section">
                <h3><i class="bi bi-rocket-takeoff-fill"></i> Ready to Get Started?</h3>
                <p class="mb-4">Load your player data to begin creating optimal squad formations</p>
                <button class="btn btn-primary btn-lg" @onclick="LoadSampleData">
                    Load Sample Players
                </button>
            </div>
        }
        else
        {
            <div class="row g-4">
                <!-- Configuration Panel -->
                <div class="col-xl-4 col-lg-5">
                    <div class="config-panel card">
                        <div class="card-header">
                            <h5>Player Configuration</h5>
                        </div>
                        <div class="card-body">
                            <!-- Player Availability Section -->
                            <div class="player-availability-container">
                                @foreach (var playerAvail in _playerAvailabilities)
                                {
                                    <div class="player-row">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="player-info">
                                                <div class="player-name">@playerAvail.Player.Name</div>
                                                <div class="player-position">@playerAvail.Player.MainPosition</div>
                                            </div>
                                            <div class="player-controls">
                                                <div class="control-group">
                                                    <label>Keeper</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" 
                                                               @bind="playerAvail.IsKeeper" 
                                                               id="keeper_@playerAvail.Player.Name">
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label>Absent</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" 
                                                               @bind="playerAvail.IsAbsent" 
                                                               id="absent_@playerAvail.Player.Name">
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label>Target Minutes</label>
                                                    <div class="input-group minutes-input">
                                                        <input type="number" class="form-control form-control-sm" 
                                                               @bind="playerAvail.TargetMinutes" 
                                                               min="0" max="60" placeholder="Min">
                                                        <span class="input-group-text">min</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Strategy Selection -->
                            <div class="strategy-section">
                                <label class="form-label">Squad Creation Strategy</label>
                                <select class="form-select" @bind="_config.Strategy">
                                    @foreach (var strategy in Enum.GetValues<SquadCreationStrategy>())
                                    {
                                        <option value="@strategy">@GetStrategyDisplayName(strategy)</option>
                                    }
                                </select>
                            </div>
                            
                            <!-- Goalkeeper Configuration -->
                            <div class="goalkeeper-config-section mt-3">
                                <h6 class="mb-2">Goalkeeper Settings</h6>
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   @bind="_config.AllowGoalkeeperRotation" 
                                                   id="allowGoalkeeperRotation">
                                            <label class="form-check-label" for="allowGoalkeeperRotation">
                                                Allow goalkeeper rotation
                                            </label>
                                        </div>
                                        <small class="text-muted">When enabled, goalkeepers share playing time</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Game Configuration -->
                            <div class="game-config-section mt-3">
                                <h6 class="mb-2">Game Settings</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label">Game Duration</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control form-control-sm" 
                                                   @bind="_config.GameDurationMinutes" 
                                                   min="30" max="120" step="5">
                                            <span class="input-group-text">min</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Min Playing Time</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control form-control-sm" 
                                                   @bind="_config.MinimumPlayingTimeMinutes" 
                                                   min="5" max="60" step="5">
                                            <span class="input-group-text">min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuration Summary -->
                            <div class="config-summary-section mt-3">
                                <h6 class="mb-2">Squad Summary</h6>
                                <div class="summary-stats">
                                    <div class="d-flex justify-content-between">
                                        <span>Available Players:</span>
                                        <span class="fw-bold">@GetAvailablePlayersCount()</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Available Goalkeepers:</span>
                                        <span class="fw-bold">@GetGoalkeeperCount()</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Target Squad Size:</span>
                                        <span class="fw-bold">@_config.PlayersOnField</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Bench Players:</span>
                                        <span class="fw-bold">@Math.Max(0, GetAvailablePlayersCount() - _config.PlayersOnField)</span>
                                    </div>
                                </div>
                                
                                @if (GetAvailablePlayersCount() < _config.PlayersOnField)
                                {
                                    <div class="alert alert-warning alert-sm mt-2">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Not enough players for a full squad
                                    </div>
                                }
                                else if (GetGoalkeeperCount() == 0)
                                {
                                    <div class="alert alert-danger alert-sm mt-2">
                                        <i class="bi bi-exclamation-circle"></i>
                                        No goalkeepers available
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-success alert-sm mt-2">
                                        <i class="bi bi-check-circle"></i>
                                        Ready to create squad
                                    </div>
                                }
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="action-buttons d-grid gap-2">
                                <button class="btn btn-success" @onclick="CreateSingleSquad">
                                    Create Optimal Squad
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="col-xl-8 col-lg-7">
                    <div class="squads-section">
                        @if (_createdSquads.Any())
                        {
                            @foreach (var squad in _createdSquads)
                            {
                                <div class="squad-card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                                            <h6>@squad.Name</h6>
                                            <div class="squad-stats">
                                                <span class="badge bg-success">@squad.OverallStrength.ToString("F1") Strength</span>
                                                <span class="badge bg-info">@GetAllUniquePlayersUsed(squad).Count Players</span>
                                                <span class="badge bg-warning">@GetSubstitutionCount(squad) Subs</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="formations-container">
                                            <!-- First Half Formation -->
                                            <div class="formation-section">
                                                <div class="formation-title">
                                                    <h6><i class="bi bi-play-circle"></i> First Half (0-30 min)</h6>
                                                </div>
                                                <FormationDisplay
                                                    FormationTitle=""
                                                    TeamStrength="@squad.OverallStrength"
                                                    GoalkeeperPlayer="@GetFirstHalfGoalkeeper(squad)"
                                                    PositionedPlayers="@GetPositionedPlayersDict(squad)"
                                                    BenchPlayers="@(new List<Player>())"
                                                    PlayerTemplate="@RenderSquadPlayer" />
                                            </div>
                                            
                                            <!-- Second Half Formation -->
                                            <div class="formation-section second-half">
                                                <div class="formation-title">
                                                    <h6><i class="bi bi-arrow-repeat"></i> Second Half (30-60 min)</h6>
                                                </div>
                                                <FormationDisplay
                                                    FormationTitle=""
                                                    TeamStrength="@squad.OverallStrength"
                                                    GoalkeeperPlayer="@GetSecondHalfGoalkeeper(squad)"
                                                    PositionedPlayers="@GetSecondHalfPositionedPlayersDict(squad)"
                                                    BenchPlayers="@(new List<Player>())"
                                                    PlayerTemplate="@RenderSquadPlayer" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Squad Analysis Component -->
                                <SquadAnalysis 
                                    Squad="@squad" 
                                    AvailableGoalkeepers="@GetAvailableGoalkeepers()" />
                            }
                        }
                        else
                        {
                            <div class="ready-state">
                                <h5>Ready to Create Your Squad!</h5>
                                <p>Configure player availability and preferences on the left, then click "Create Squad" to generate optimal formations based on your chosen strategy.</p>
                                <div class="mt-4">
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb-fill"></i> <strong>Pro Tip:</strong> Try different strategies to see various squad compositions. 
                                        The system considers player positions, skills, and availability to create balanced teams.
                                    </small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>
